@using Pertamina.SolutionTemplate.Shared.Data.Queries.GetAllMasterData
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Calendars
@using Syncfusion.Blazor.Cards
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Inputs
@using Pertamina.SolutionTemplate.Shared.Data.Queries.GetSingleData;
@using Syncfusion.Blazor.Popups
@using Pertamina.SolutionTemplate.Bsui.Services.Authorization.IdAMan
@using Pertamina.SolutionTemplate.Shared.Model;
@page "/Catalog/Edit"
@attribute [Authorize]
@inject IOptions<IdAManAuthorizationOptions> _idamaninfo
<style>
    .e-highlight {
        background-color: yellow;
    }

    .e-input-group.e-control-wrapper.e-control-container.e-float-input .e-float-text::after {
        content: "*";
        color: red;
    }
</style>
<BrowserTabTitle>
    @CommonDisplayTextFor.Edit @DisplayTextFor.Catalog
</BrowserTabTitle>
<MudBreadcrumbs Items="_breadcrumbItems" />
<PageHeader Title="@($"{CommonDisplayTextFor.Edit} {DisplayTextFor.Catalog}")" />
<ErrorViewer Error="_error" />
<LoadingLinear IsVisible="_isLoading" />
<AuthorizeView Context="authorizeContext">
    <Authorized>
        @if (@authorizeContext.User.GetCompanyCode() == "2186")
        {
            @if (!@_isLoading)
            {
                @*  <MudItem md="4"
        sm="12"
        xs="12">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="@RouteFor.AddDraftHistoricalApplicationPhase">Add New Draft Historical App Phase</MudButton>
        </MudItem> *@
                <EditForm Model="_request"
                          OnInvalidSubmit="OnInvalidSubmit">
                    <FluentValidationValidator />
                    <SfCard>
                        <CardContent>
                            <MudFocusTrap>
                                <MudGrid>
                                    <MudItem xs="12">
                                        <SfAutoComplete @ref="_sfapplicationame" Enabled=@Enabled_sfdropdownname FloatLabelType="FloatLabelType.Auto" TValue="string" TItem="GetSingleData" Placeholder="Code App" @bind-Value="@_request.Code_Apps_Update" PopupHeight="200px" CssClass="e-multi-column" DataSource="@_dataCount" AllowFiltering="true" Highlight="@Highlight" ShowPopupButton="true">
                                            <AutoCompleteFieldSettings Value="Code_Apps"></AutoCompleteFieldSettings>
                                            <AutoCompleteEvents TValue="string" TItem="GetSingleData" Filtering="OnFilter" ValueChange="@ValueChangeHandler" Focus="OnFocusAppName"></AutoCompleteEvents>
                                            <AutoCompleteTemplates TItem="GetSingleData">
                                                <HeaderTemplate>
                                                    <table>
                                                        <tr>
                                                            <th>Code</th>
                                                            <th>Name</th>
                                                            <th>Detail</th>
                                                        </tr>
                                                    </table>
                                                </HeaderTemplate>
                                                <ItemTemplate Context="DialogContext">
                                                    <table>
                                                        <tbody>
                                                            <tr>
                                                                <td>
                                                                    @((MarkupString)_sfapplicationame.HighLightSearch(DialogContext.Code_Apps, true, Syncfusion.Blazor.DropDowns.FilterType.Contains))
                                                                </td>
                                                                <td>
                                                                    @((MarkupString)_sfapplicationame.HighLightSearch(DialogContext.Application_Name, true, Syncfusion.Blazor.DropDowns.FilterType.Contains))
                                                                </td>
                                                                <td>
                                                                    @((MarkupString)_sfapplicationame.HighLightSearch(DialogContext.Description, true, Syncfusion.Blazor.DropDowns.FilterType.Contains))
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </ItemTemplate>
                                            </AutoCompleteTemplates>
                                        </SfAutoComplete>
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudTextField Label="Application Name"
                                                      Required="true" Disabled="@Enabled_sfdropdownphase" @bind-Value="_request.Application_Name" />
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudTextField Label="Description"
                                                      Required="true"
                                                      Disabled="@Enabled_sfdropdownphase"
                                                      @bind-Value="_request.Description" />
                                    </MudItem>
                                    <MudItem xs="6">
                                        <SfAutoComplete @ref="_sfapparea" Enabled="@Disable_sfdropdownphase" FloatLabelType="FloatLabelType.Auto" TValue="string" TItem="GetAllMasterData" Placeholder="Application Area" @bind-Value="@_request.Application_Area" PopupHeight="200px" CssClass="e-multi-column" DataSource="@_dataCountArea" AllowFiltering="true" Highlight="@Highlight" ShowPopupButton="true">
                                            <AutoCompleteFieldSettings Value="Nama"></AutoCompleteFieldSettings>
                                            <AutoCompleteEvents TValue="string" TItem="GetAllMasterData" Filtering="OnFilterArea" Focus="OnFocusArea"></AutoCompleteEvents>
                                            <AutoCompleteTemplates TItem="GetAllMasterData">
                                                <HeaderTemplate>
                                                    <table>
                                                        <tr>
                                                            <th>Name</th>
                                                            <th>Detail</th>
                                                        </tr>
                                                    </table>
                                                </HeaderTemplate>
                                                <ItemTemplate Context="DialogContext">
                                                    <table>
                                                        <tbody>
                                                            <tr>
                                                                <td>
                                                                    @((MarkupString)_sfapparea.HighLightSearch(DialogContext.Nama, true, Syncfusion.Blazor.DropDowns.FilterType.Contains))
                                                                </td>
                                                                <td>
                                                                    @((MarkupString)_sfapparea.HighLightSearch(DialogContext.Keterangan, true, Syncfusion.Blazor.DropDowns.FilterType.Contains))
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </ItemTemplate>
                                            </AutoCompleteTemplates>
                                        </SfAutoComplete>
                                    </MudItem>
                                    <MudItem xs="6">
                                        <SfAutoComplete @ref="_sfapptype" Enabled="@Disable_sfdropdownphase" FloatLabelType="FloatLabelType.Auto" TValue="string" TItem="GetAllMasterData" Placeholder="Application Type" @bind-Value="@_request.Application_Type" PopupHeight="200px" CssClass="e-multi-column" DataSource="@_dataCountType" AllowFiltering="true" Highlight="@Highlight" ShowPopupButton="true">
                                            <AutoCompleteFieldSettings Value="Nama"></AutoCompleteFieldSettings>
                                            <AutoCompleteEvents TValue="string" TItem="GetAllMasterData" Filtering="OnFilterType" Focus="OnFocusType"></AutoCompleteEvents>
                                            <AutoCompleteTemplates TItem="GetAllMasterData">
                                                <HeaderTemplate>
                                                    <table>
                                                        <tr>
                                                            <th>Name</th>
                                                            <th>Detail</th>
                                                        </tr>
                                                    </table>
                                                </HeaderTemplate>
                                                <ItemTemplate Context="DialogContext">
                                                    <table>
                                                        <tbody>
                                                            <tr>
                                                                <td>
                                                                    @((MarkupString)_sfapparea.HighLightSearch(DialogContext.Nama, true, Syncfusion.Blazor.DropDowns.FilterType.Contains))
                                                                </td>
                                                                <td>
                                                                    @((MarkupString)_sfapparea.HighLightSearch(DialogContext.Keterangan, true, Syncfusion.Blazor.DropDowns.FilterType.Contains))
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </ItemTemplate>
                                            </AutoCompleteTemplates>
                                        </SfAutoComplete>
                                    </MudItem>
                                    <MudItem xs="6">
                                        <SfAutoComplete @ref="_sfappstatus" Enabled="@Disable_sfdropdownphase" FloatLabelType="FloatLabelType.Auto" TValue="string" TItem="GetAllMasterData" Placeholder="Application Status" @bind-Value="@_request.Application_Status" PopupHeight="200px" CssClass="e-multi-column" DataSource="@_dataCountStatus" AllowFiltering="true" Highlight="@Highlight" ShowPopupButton="true">
                                            <AutoCompleteFieldSettings Value="Nama"></AutoCompleteFieldSettings>
                                            <AutoCompleteEvents TValue="string" TItem="GetAllMasterData" Filtering="OnFilterStatus" Focus="OnFocusStatus"></AutoCompleteEvents>
                                            <AutoCompleteTemplates TItem="GetAllMasterData">
                                                <HeaderTemplate>
                                                    <table>
                                                        <tr>
                                                            <th>Name</th>
                                                            <th>Detail</th>
                                                        </tr>
                                                    </table>
                                                </HeaderTemplate>
                                                <ItemTemplate Context="DialogContext">
                                                    <table>
                                                        <tbody>
                                                            <tr>
                                                                <td>
                                                                    @((MarkupString)_sfapparea.HighLightSearch(DialogContext.Nama, true, Syncfusion.Blazor.DropDowns.FilterType.Contains))
                                                                </td>
                                                                <td>
                                                                    @((MarkupString)_sfapparea.HighLightSearch(DialogContext.Keterangan, true, Syncfusion.Blazor.DropDowns.FilterType.Contains))
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </ItemTemplate>
                                            </AutoCompleteTemplates>
                                        </SfAutoComplete>
                                    </MudItem>
                                    <MudItem xs="6">
                                        <SfAutoComplete @ref="_sfappusman" Enabled="@Disable_sfdropdownphase" FloatLabelType="FloatLabelType.Auto" TValue="string" TItem="GetAllMasterData" Placeholder="User Management Integration" @bind-Value="@_request.User_Management_Integration" PopupHeight="200px" CssClass="e-multi-column" DataSource="@_dataCountUsman" AllowFiltering="true" Highlight="@Highlight" ShowPopupButton="true">
                                            <AutoCompleteFieldSettings Value="Nama"></AutoCompleteFieldSettings>
                                            <AutoCompleteEvents TValue="string" TItem="GetAllMasterData" Filtering="OnFilterUsman" Focus="OnFocusUsman"></AutoCompleteEvents>
                                            <AutoCompleteTemplates TItem="GetAllMasterData">
                                                <HeaderTemplate>
                                                    <table>
                                                        <tr>
                                                            <th>Name</th>
                                                            <th>Detail</th>
                                                        </tr>
                                                    </table>
                                                </HeaderTemplate>
                                                <ItemTemplate Context="DialogContext">
                                                    <table>
                                                        <tbody>
                                                            <tr>
                                                                <td>
                                                                    @((MarkupString)_sfapparea.HighLightSearch(DialogContext.Nama, true, Syncfusion.Blazor.DropDowns.FilterType.Contains))
                                                                </td>
                                                                <td>
                                                                    @((MarkupString)_sfapparea.HighLightSearch(DialogContext.Keterangan, true, Syncfusion.Blazor.DropDowns.FilterType.Contains))
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </ItemTemplate>
                                            </AutoCompleteTemplates>
                                        </SfAutoComplete>
                                    </MudItem>
                                    <MudItem xs="3">
                                        <MudGrid>
                                            <MudItem xs="8">
                                                <MudTextField Label="Business Owner Name"
                                                              Required="true" Disabled="true"
                                                              @bind-Value="_request.Business_Owner_Nama" />
                                            </MudItem>
                                            <MudItem xs="4">
                                                <MudIconButton Disabled="@Enabled_sfdropdownphase" Icon="@Icons.Material.Filled.Search" @onclick="@(() => OnShowDialogIdaman("bisuserkbo"))" Variant="MudBlazor.Variant.Filled" Color="MudBlazor.Color.Primary" Size="MudBlazor.Size.Small" />
                                            </MudItem>
                                        </MudGrid>

                                    </MudItem>
                                    <MudItem xs="3">
                                        <MudTextField Label="Business Owner Email"
                                                      Required="true" Disabled="true"
                                                      @bind-Value="_request.Business_Owner_Email" />
                                    </MudItem>
                                    <MudItem xs="3">
                                        <MudTextField Label="Business Owner KBO"
                                                      Required="true" Disabled="true"
                                                      @bind-Value="_request.Business_Owner_KBO" />
                                    </MudItem>
                                    <MudItem xs="3">
                                        <MudTextField Label="Business Owner Jabatan"
                                                      Required="true" Disabled="true"
                                                      @bind-Value="_request.Business_Owner_Jabatan" />
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudGrid>
                                            <MudItem xs="8">
                                                <MudTextField Label="Business Owner PIC"
                                                              Required="true" Disabled="true"
                                                              @bind-Value="_request.Business_Owner_PIC" />
                                            </MudItem>
                                            <MudItem xs="4">
                                                <MudIconButton Disabled="@Enabled_sfdropdownphase" Icon="@Icons.Material.Filled.Search" @onclick="@(() => OnShowDialogIdaman("bisusernonkbopic"))" Variant="MudBlazor.Variant.Filled" Color="MudBlazor.Color.Primary" Size="MudBlazor.Size.Small" />
                                            </MudItem>
                                        </MudGrid>
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudTextField Label="Business Owner PIC Email"
                                                      Required="true" Disabled="true"
                                                      @bind-Value="_request.Business_Owner_PIC_Email" />
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudGrid>
                                            <MudItem xs="8">
                                                <MudTextField Label="Business Analyst"
                                                              Required="true" Disabled="true"
                                                              @bind-Value="_request.Business_Analyst" />
                                            </MudItem>
                                            <MudItem xs="4">
                                                <MudIconButton Disabled="@Enabled_sfdropdownphase" Icon="@Icons.Material.Filled.Search" @onclick="@(() => OnShowDialogIdaman("bisusernonkboanalyst"))" Variant="MudBlazor.Variant.Filled" Color="MudBlazor.Color.Primary" Size="MudBlazor.Size.Small" />
                                            </MudItem>
                                        </MudGrid>
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudTextField Label="Developer"
                                                      Required="true" Disabled="@Enabled_sfdropdownphase"
                                                      @bind-Value="_request.Developer" />
                                    </MudItem>
                                    <MudItem xs="6">

                                        <SfDatePicker TValue="DateTime" @bind-Value="_request.Start_Development" Enabled="@Disable_sfdropdownphase" Placeholder='Choose a Start Development Date *Required' FloatLabelType='@FloatLabelType.Auto' @ref="@_dateStartDev">
                                            <DatePickerEvents TValue="DateTime" Focus="FocusHandlerStartDev"></DatePickerEvents>

                                        </SfDatePicker>
                                    </MudItem>
                                    <MudItem xs="6">
                                        <SfDatePicker TValue="DateTime" @bind-Value="_request.Start_Implementation" Enabled="@Disable_sfdropdownphase" Placeholder='Choose a Start Go Live / Implementation Date *Required' FloatLabelType='@FloatLabelType.Auto' @ref="@_dateStartImplement">
                                            <DatePickerEvents TValue="DateTime" Focus="FocusHandlerStartImplement"></DatePickerEvents>
                                        </SfDatePicker>
                                    </MudItem>
                                    @* <MudItem xs="6">
                                        <SfDatePicker TValue="DateTime" @bind-Value="_request.Start_Rationalization" Enabled="@Disable_sfdropdownphase" Placeholder='Choose a Start Rationalize Date' FloatLabelType='@FloatLabelType.Auto' @ref="@_dateStartRationalize">
                                            <DatePickerEvents TValue="DateTime" Focus="FocusHandlerStartImplement"></DatePickerEvents>
                                        </SfDatePicker>
                                    </MudItem>
                                    <MudItem xs="6">
                                        <SfDatePicker TValue="DateTime" @bind-Value="_request.Start_Sunset" Enabled="@Disable_sfdropdownphase" Placeholder='Choose a Start Sunset Date' FloatLabelType='@FloatLabelType.Auto' @ref="@_dateStartSunset">
                                            <DatePickerEvents TValue="DateTime" Focus="FocusHandlerStartImplement"></DatePickerEvents>
                                        </SfDatePicker>
                                    </MudItem>
                                    <MudItem xs="12">
                                        <SfCheckBox Label="Sunset" @bind-Checked="_isCheckedSunset" Disabled="@Enabled_sfdropdownphase"></SfCheckBox>
                                        <SfCheckBox Label="Rationalization" @bind-Checked="_isCheckedRationalize" Disabled="@Enabled_sfdropdownphase"></SfCheckBox>
                                    </MudItem> *@
                                </MudGrid>
                            </MudFocusTrap>
                            <SfDialog Target="#target" Width="700px" IsModal="true" ShowCloseIcon="true" @bind-Visible="Visibility">
                                <DialogTemplates>
                                    <Header>@_strHeadDialog</Header>
                                    <Content>
                                        <p>
                                            @((MarkupString)@_strContentDialog)
                                        </p>
                                    </Content>
                                </DialogTemplates>
                                <DialogEvents OnOpen="@DialogOpen" Closed="@DialogClose"></DialogEvents>
                                <DialogButtons>

                                </DialogButtons>
                            </SfDialog>
                            <SfDialog Target="#target" Width="900px" IsModal="true" ShowCloseIcon="true" @bind-Visible="VisibilityGrid">
                                <DialogTemplates>
                                    <Header>Show Data From Idaman</Header>
                                    <Content>
                                        <MudGrid>
                                            <MudItem xs="6">
                                                <MudTextField Label="Input Name"
                                                              @bind-Value="_sinputbisnisuseridaman" />
                                            </MudItem>
                                            <MudItem xs="6">
                                                <MudIconButton Icon="@Icons.Material.Filled.Search" @onclick="@(() => OnBindIdaman(_sinputbisnisuseridaman))" Variant="MudBlazor.Variant.Filled" Color="MudBlazor.Color.Primary" Size="MudBlazor.Size.Small" />
                                            </MudItem>
                                            <LoadingLinear IsVisible="_isLoadingIdaman" />
                                            @if (!@_isLoadingIdaman)
                                            {
                                                @if (!string.IsNullOrEmpty(_strerrordialogidaman))
                                                {
                                                    <MudItem xs="12">
                                                        <p>
                                                            @((MarkupString)@_strerrordialogidaman)
                                                        </p>
                                                    </MudItem>
                                                }
                                                <MudItem xs="12">
                                                    <SfGrid ID="Grid" @ref=_blazorDataGridbisuser DataSource="@_dataCountbisuserwithkbo" AllowTextWrap="true">
                                                        <GridEvents TValue="IdamanUsers" CommandClicked="CommandClickGridbisuser"></GridEvents>
                                                        <GridColumns>
                                                            <GridColumn Field="@nameof(IdamanUsers.displayName)" HeaderText="Display Name" Width="120"></GridColumn>
                                                            <GridColumn Field="@nameof(IdamanUsers.email)" HeaderText="Email" Width="150"></GridColumn>
                                                            <GridColumn Field="@nameof(IdamanUsers.jobTitle)" HeaderText="Job Title" Width="150"></GridColumn>
                                                            <GridColumn Field="@nameof(IdamanUsers.position.kbo)" HeaderText="KBO" Width="100"></GridColumn>
                                                            <GridColumn Field="@nameof(IdamanUsers.companyName)" HeaderText="Company Name" Width="140"></GridColumn>
                                                            <GridColumn HeaderText="Manage Records" Width="150">
                                                                <GridCommandColumns>
                                                                    <GridCommandColumn Type="CommandButtonType.Edit" ButtonOption="@(new CommandButtonOptions() {IconCss="e-icons e-check-large", CssClass="e-round-corner e-primary" })"></GridCommandColumn>
                                                                </GridCommandColumns>
                                                            </GridColumn>
                                                        </GridColumns>
                                                    </SfGrid>
                                                </MudItem>

                                            }
                                        </MudGrid>
                                    </Content>
                                </DialogTemplates>
                                <DialogEvents OnOpen="@DialogOpenGrid" Closed="@DialogCloseGrid"></DialogEvents>
                                <DialogButtons>

                                </DialogButtons>
                            </SfDialog>

                        </CardContent>
                        <CardFooter>
                            <CardFooterContent>
                                <MudButton Variant="Variant.Filled"
                                           Color="Color.Default"
                                           Href="@RouteFor.Request"
                                           Class="mr-2">
                                    @CommonDisplayTextFor.Cancel
                                </MudButton>
                            </CardFooterContent>
                            <CardFooterContent>
                                <MudButton Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           ButtonType="MudBlazor.ButtonType.Submit"
                                           OnClick="@(() => OnClickBtnUpdateAndWaiting(context))"
                                           hidden="@Enabled_sfdropdownphase">
                                    Update and Waiting for Approval
                                </MudButton>
                            </CardFooterContent>
                            @*  <CardFooterContent>
                    <MudButton Variant="Variant.Filled"
                    Color="Color.Primary"
                    OnClick="@(() => OnClickBtnRationalizeAndWaiting(context))"
                    ButtonType="MudBlazor.ButtonType.Submit" hidden="@Enabled_sfdropdownphase">
                    Rationalization and Waiting for Approval
                    </MudButton>
                    </CardFooterContent>
                    <CardFooterContent>
                    @if (_request.IsDeleted == "true"){
                    <MudButton Variant="Variant.Filled"
                    Color="Color.Primary"
                    OnClick="@(() => OnClickBtnActiveAndWaiting(context))"
                    ButtonType="MudBlazor.ButtonType.Submit" hidden="@Enabled_sfdropdownphase">
                    Active and Waiting for Approval
                    </MudButton>
                    }
                    else
                    {
                    <MudButton Variant="Variant.Filled"
                    Color="Color.Primary"
                    OnClick="@(() => OnClickBtnSunsesAndWaiting(context))"
                    ButtonType="MudBlazor.ButtonType.Submit" hidden="@Enabled_sfdropdownphase">
                    Sunset and Waiting for Approval
                    </MudButton>
                    }
                    </CardFooterContent>*@
                        </CardFooter>
                    </SfCard>

                </EditForm>

            }
        }
        else
        {
            <div class="d-flex justify-space-around mt-16">
                <div>
                    <MudText Typo="Typo.h2">Kode Perusahaan tidak terdaftar</MudText>
                    <MudText Typo="Typo.body1">Aplikasi ini hanya bisa di akses untuk user dari KPI (Kilang Pertamina Indonesia)</MudText>
                </div>
                <div>
                    <img src="img/unauthorized.png" alt="Unauthorized" width="300" />
                </div>
            </div>
        }

    </Authorized>
</AuthorizeView>
