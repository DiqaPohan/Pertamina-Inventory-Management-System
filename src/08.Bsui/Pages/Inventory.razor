@page "/inventory"
@using MudBlazor
@using Pertamina.SolutionTemplate.Bsui.ViewModels
@using Pertamina.SolutionTemplate.Shared.Common.Enums;
@attribute [AllowAnonymous]

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-12">
    <!-- Header Section -->
    <div class="header-section d-flex justify-space-between align-center mb-8">
        <div>
            <MudText Typo="Typo.h4" Style="font-weight:600; color: black; letter-spacing: -1px;">Master Inventory</MudText>
            <MudText Typo="Typo.subtitle1" Style="color: rgba(0,0,0,0.5); font-weight: 400;">Kelola stok dan lokasi penyimpanan barang</MudText>
        </div>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Add"
                   Size="Size.Large"
                   OnClick="ViewModel.OpenAddDialog"
                   DisableElevation="true"
                   Class="pa-4"
                   Style="border-radius: 12px;">
            Tambah Barang
        </MudButton>
    </div>

    <!-- Search Bar -->
    <MudTextField @bind-Value="ViewModel.SearchString"
                  Immediate="true"
                  Placeholder="Cari nama barang atau nomor rak..."
                  Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Filled.Search"
                  IconSize="Size.Medium"
                  Class="mb-9"
                  Style="border-radius: 32px"
                  Variant="Variant.Outlined" />

    <!-- Content Area -->
    @if (ViewModel.IsLoading)
    {
        <div class="d-flex justify-center align-center pa-12">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        </div>
    }
    else if (!ViewModel.FilteredItems.Any())
    {
        <div class="empty-state text-center pa-12">
            <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Default" />
            <MudText Typo="Typo.h6" Class="mt-4">Tidak ada barang ditemukan</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">Coba kata kunci pencarian lain atau cek koneksi database.</MudText>
        </div>
    }
    else
    {
        @* --- LOGIC PEMISAHAN DATA BERDASARKAN STATUS --- *@
        var activeItems = ViewModel.FilteredItems.Where(x => x.Status != ItemStatus.Pending).ToList();
        var pendingItems = ViewModel.FilteredItems.Where(x => x.Status == ItemStatus.Pending).ToList();

        <!-- SECTION 1: BARANG AKTIF -->
        <MudGrid Spacing="4">
            @foreach (var item in activeItems)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard Elevation="0" Style="border: 1px solid rgba(0,0,0,0.1); border-radius: 16px; overflow: hidden; height: 100%;">
                        <div style="height: 200px; background-color: #f5f5f5; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative;">
                            <img src="@item.ImageUrl" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='https://via.placeholder.com/400?text=No+Image'" />
                            @if (item.IsExpiredSoon)
                            {
                                <div style="position:absolute; top:10px; right:10px; background:rgba(255,0,0,0.8); color:white; padding:4px 8px; border-radius:4px; font-size:12px; display:flex; align-items:center; gap:4px;">
                                    <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" />
                                    <span>SEGERA KELUARKAN</span>
                                </div>
                            }
                        </div>

                        <MudCardContent>
                            <div class="d-flex justify-space-between align-center mb-2">
                                <MudText Typo="Typo.h6" Style="font-weight: 700;">@item.Nama</MudText>
                                @switch (item.ItemCategory)
                                {
                                    case ItemCategory.Light:
                                        <MudChip T="string" Color="Color.Success" Size="Size.Small" Variant="Variant.Outlined">Light</MudChip>
                                        break;
                                    case ItemCategory.Medium:
                                        <MudChip T="string" Color="Color.Warning" Size="Size.Small" Variant="Variant.Outlined">Medium</MudChip>
                                        break;
                                    case ItemCategory.Heavy:
                                        <MudChip T="string" Color="Color.Error" Size="Size.Small" Variant="Variant.Outlined">Heavy</MudChip>
                                        break;
                                }
                            </div>

                            <div class="d-flex align-center mb-1">
                                <MudIcon Icon="@Icons.Material.Filled.GridView" Size="Size.Small" Color="Color.Primary" Class="mr-2" />
                                <MudText Typo="Typo.body2"><b>Rak:</b> @item.NoRak</MudText>
                            </div>

                            <div class="d-flex align-center mb-1">
                                <MudIcon Icon="@Icons.Material.Filled.Inventory" Size="Size.Small" Color="Color.Secondary" Class="mr-2" />
                                <MudText Typo="Typo.body2"><b>Stok:</b> @item.Stok @item.Satuan</MudText>
                            </div>

                            @if (item.ExpDate.HasValue)
                            {
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Color="Color.Default" Class="mr-2" />
                                    <MudText Typo="Typo.body2">EXP: @item.ExpDate.Value.ToString("dd MMM yyyy")</MudText>
                                </div>
                            }
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Variant="Variant.Text" Color="Color.Primary" FullWidth="true" OnClick="@(() => ViewModel.OpenEditDialog(item))">Edit</MudButton>
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => ViewModel.DeleteItem(item.Id))" />
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>

        <!-- --- PEMISAH UNTUK PENDING --- -->
        @if (pendingItems.Any())
        {
            <div class="d-flex align-center gap-4 mt-12 mb-6">
                <div style="flex-grow: 1; height: 1px; background: rgba(0,0,0,0.1);"></div>
                <MudText Typo="Typo.button" Style="color: rgba(0,0,0,0.4); font-weight:700; white-space:nowrap;">MENUNGGU PENEMPATAN (PENDING)</MudText>
                <div style="flex-grow: 1; height: 1px; background: rgba(0,0,0,0.1);"></div>
            </div>

            <!-- SECTION 2: BARANG PENDING (OPACITY LEBIH RENDAH + INFO STOK & KATEGORI) -->
            <MudGrid Spacing="4">
                @foreach (var item in pendingItems)
                {
                    <MudItem xs="12" sm="6" md="4" lg="3">
                        <MudCard Elevation="0" Style="border: 1px dashed rgba(0,0,0,0.2); border-radius: 16px; overflow: hidden; height: 100%; opacity: 0.35;">
                            <div style="height: 200px; background-color: #f5f5f5; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; filter: grayscale(1);">
                                <img src="@item.ImageUrl" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='https://via.placeholder.com/400?text=No+Image'" />
                                <div style="position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.4); color:white; text-align:center; padding:4px; font-size:10px;">PENDING SCAN</div>
                            </div>

                            <MudCardContent>
                                <div class="d-flex justify-space-between align-center mb-2">
                                    <MudText Typo="Typo.h6" Style="font-weight: 700; color: #757575;">@item.Nama</MudText>
                                    @switch (item.ItemCategory)
                                    {
                                        case ItemCategory.Light:
                                            <MudChip T="string" Color="Color.Success" Size="Size.Small" Variant="Variant.Text" Style="opacity: 0.6;">Light</MudChip>
                                            break;
                                        case ItemCategory.Medium:
                                            <MudChip T="string" Color="Color.Warning" Size="Size.Small" Variant="Variant.Text" Style="opacity: 0.6;">Medium</MudChip>
                                            break;
                                        case ItemCategory.Heavy:
                                            <MudChip T="string" Color="Color.Error" Size="Size.Small" Variant="Variant.Text" Style="opacity: 0.6;">Heavy</MudChip>
                                            break;
                                    }
                                </div>
                                <div class="d-flex align-center mb-1">
                                    <MudIcon Icon="@Icons.Material.Filled.GridView" Size="Size.Small" Color="Color.Default" Class="mr-2" />
                                    <MudText Typo="Typo.body2">Target: @item.NoRak</MudText>
                                </div>
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.Inventory" Size="Size.Small" Color="Color.Default" Class="mr-2" />
                                    <MudText Typo="Typo.body2">Stok Baru: @item.Stok @item.Satuan</MudText>
                                </div>
                            </MudCardContent>
                            <MudCardActions>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => ViewModel.DeleteItem(item.Id))" />
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        }
    }
</MudContainer>

<!-- Dialog Form Tetap Utuh -->
<MudDialog @bind-IsVisible="ViewModel.IsAddDialogOpen" Options="ViewModel.DialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h5" Style="font-weight:700;">@(ViewModel.EditingItemId.HasValue ? "Edit Barang" : "Tambah Barang")</MudText>
    </TitleContent>
    <DialogContent>
        <div class="d-flex flex-column flex-md-row gap-6">
            <!-- Image Upload Section -->
            <div style="flex: 1;">
                <MudText Typo="Typo.subtitle2" Class="mb-2">Gambar Barang</MudText>
                <div class="image-upload-area" @onclick="ViewModel.TriggerFileInput" style="cursor:pointer; border: 2px dashed #ccc; border-radius:12px; height:250px; display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative;">
                    @if (!string.IsNullOrEmpty(ViewModel.ImagePreview))
                    {
                        <img src="@ViewModel.ImagePreview" style="width:100%; height:100%; object-fit:cover;" />
                        <div style="position:absolute; bottom:10px; right:10px; background:white; border-radius:50%; padding:8px;">
                            <MudIcon Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" />
                        </div>
                    }
                    else
                    {
                        <div class="text-center">
                            <MudIcon Icon="@Icons.Material.Filled.CloudUpload" Size="Size.Large" Color="Color.Default" />
                            <MudText Typo="Typo.caption" Display="Display.Block">Klik untuk upload gambar</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">JPG, PNG, max 5MB</MudText>
                        </div>
                    }
                </div>
                <InputFile id="fileInput" OnChange="ViewModel.HandleFileSelected" accept="image/*" style="display: none;" />

                @if (!string.IsNullOrEmpty(ViewModel.ImagePreview))
                {
                    <MudButton OnClick="ViewModel.ClearImage" Color="Color.Error" StartIcon="@Icons.Material.Filled.Delete" Size="Size.Small" FullWidth="true" Class="mt-2">Hapus Gambar</MudButton>
                }
            </div>

            <!-- Form Section -->
            <div style="flex: 2;">
                <!-- Auto Suggestion Name -->
                <MudAutocomplete T="string"
                                 Label="Nama Barang"
                                 Value="ViewModel.NewItemName"
                                 ValueChanged="@((string v) => ViewModel.OnItemNameChanged(v))"
                                 SearchFunc="ViewModel.SearchExistingItems"
                                 Variant="Variant.Outlined"
                                 Required="true"
                                 RequiredError="Nama barang wajib diisi"
                                 Placeholder="Ketik atau pilih nama barang..."
                                 CoerceText="true"
                                 CoerceValue="true"
                                 Class="mb-4" />

                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudSelect T="string"
                                   Label="Pilih Rak"
                                   @bind-Value="ViewModel.SelectedRackId"
                                   Variant="Variant.Outlined"
                                   Required="true"
                                   Disabled="ViewModel.IsRakAutoFilled"
                                   Placeholder="Pilih lokasi..."
                                   AnchorOrigin="Origin.BottomCenter">
                            @foreach (var rack in ViewModel.Racks)
                            {
                                <MudSelectItem Value="@rack.RackId">@rack.RackId (@rack.Status)</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudSelect T="ItemCategory"
                                   Label="Kategori"
                                   @bind-Value="ViewModel.NewItemCategory"
                                   Variant="Variant.Outlined"
                                   Disabled="ViewModel.IsRakAutoFilled"
                                   AnchorOrigin="Origin.BottomCenter">
                            <MudSelectItem Value="ItemCategory.Light">Ringan (Light)</MudSelectItem>
                            <MudSelectItem Value="ItemCategory.Medium">Sedang (Medium)</MudSelectItem>
                            <MudSelectItem Value="ItemCategory.Heavy">Berat (Heavy)</MudSelectItem>
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudNumericField @bind-Value="ViewModel.NewItemQty"
                                         Label="Jumlah Stok"
                                         Variant="Variant.Outlined"
                                         Min="1"
                                         Required="true" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="ViewModel.NewItemUnit"
                                      Label="Satuan"
                                      Variant="Variant.Outlined"
                                      Placeholder="Contoh: pcs" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudDatePicker Label="Tanggal Kadaluarsa"
                                       @bind-Date="ViewModel.NewItemExpDate"
                                       Variant="Variant.Outlined"
                                       Editable="true" />
                    </MudItem>
                </MudGrid>
            </div>
        </div>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="ViewModel.CancelDialog" Variant="Variant.Text">Batal</MudButton>
        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   OnClick="ViewModel.HandleSubmit"
                   Disabled="@(!ViewModel.IsFormValid || ViewModel.IsLoading)">
            @if (ViewModel.IsLoading)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                <MudText Class="ms-2">Menyimpan...</MudText>
            }
            else
            {
                <MudText>Simpan</MudText>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

<MudSnackbarProvider />